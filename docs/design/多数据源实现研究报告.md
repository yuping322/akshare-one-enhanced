# 多数据源实现研究报告

## 1. akshare 数据源架构分析

### 1.1 源命名和组织规范

akshare 采用**清晰的文件组织和命名规范**：

```
akshare/
├── stock/
│   ├── stock_zh_a_sina.py        # 新浪财经数据源
│   ├── stock_zh_a_special.py     # 特殊股票数据
│   └── stock_info_em.py          # 东方财富数据源
├── stock_feature/
│   ├── stock_hist_em.py          # 东方财富历史行情 (~1000行)
│   ├── stock_hist_sina.py        # 新浪财经历史行情 (如果存在)
│   └── ...
├── futures/
│   ├── futures_hist_em.py        # 东方财富期货数据
│   ├── futures_zh_sina.py        # 新浪财经期货数据
│   └── futures_hq_sina.py        # 新浪财经期货行情
└── ...
```

**命名规律**：
- `<data_type>_<source>.py` 格式
- 示例：`stock_zh_a_sina.py`, `futures_zh_sina.py`, `stock_info_em.py`
- 便于快速定位特定源的实现

### 1.2 核心数据源实现分析

#### 股票历史行情 (stock_zh_a_hist)

**东方财富实现** (`stock_hist_em.py` Line 952-1000):
```python
def stock_zh_a_hist(
    symbol: str = "000001",
    period: str = "daily",      # daily/weekly/monthly
    start_date: str = "19700101",
    end_date: str = "20500101",
    adjust: str = "",            # qfq/hfq/空字符串
) -> pd.DataFrame:
    # URL: https://push2his.eastmoney.com/api/qt/stock/kline/get
    # 参数映射: period → klt参数 (101=日, 102=周, 103=月)
    # 返回: DataFrame with columns [日期, 开盘, 收盘, ...]
```

**新浪财经实现** (`stock_zh_a_sina.py` Line 127-200):
```python
def stock_zh_a_daily(
    symbol: str = "sh603843",
    start_date: str = "19900101",
    end_date: str = "21000118",
    adjust: str = "",
) -> pd.DataFrame:
    # URL: https://finance.sina.com.cn/realstock/company/{symbol}/nc.shtml
    # 特殊处理: JS解密 (py_mini_racer)
    # 复权因子: 单独API获取
    # 返回: 同样的DataFrame格式
```

**关键差异**：
| 方面 | 东方财富 | 新浪财经 |
|------|----------|----------|
| 易用性 | ⭐⭐⭐⭐ | ⭐⭐ (需JS解密) |
| 稳定性 | ⭐⭐⭐⭐⭐ | ⭐⭐⭐⭐ |
| 数据完整性 | ⭐⭐⭐⭐⭐ | ⭐⭐⭐⭐ |
| 历史数据 | 完整 | 较完整 |

#### 期货历史行情 (futures_zh_*_*hist)

**东方财富期货** (`futures_hist_em.py` Line 1-50):
```python
# 特点:
# 1. 需要解析期货品种对照表
# 2. API: https://futsse-static.eastmoney.com/redis
# 3. 支持分钟/小时/日/周/月级别
# 4. 自动主力合约切换
```

**新浪财经期货** (`futures_zh_sina.py` Line 1-50):
```python
# 特点:
# 1. JS解密复杂度高
# 2. 支持实时和历史行情
# 3. 需维护期货品种映射表
# 4. IP限制严格
```

### 1.3 数据源优先级建议

基于 akshare 1057个接口的分布：

#### 股票相关 (411个接口)

**历史/实时行情**:
1. **东方财富** (eastmoney) - 最稳定，字段最全 ⭐⭐⭐⭐⭐
2. **新浪财经** (sina) - 备用，稳定 ⭐⭐⭐⭐
3. **腾讯财经** (tencent) - 实时性强 ⭐⭐⭐

**财务数据**:
1. **东方财富** (eastmoney) - 完整权威 ⭐⭐⭐⭐⭐
2. **新浪财经** (sina) - 数据基本一致 ⭐⭐⭐⭐
3. **巨潮资讯** (cninfo) - 官方准确 ⭐⭐⭐⭐⭐

**热点/龙虎榜**:
1. **东方财富** (eastmoney) - 原始数据 ⭐⭐⭐⭐⭐
2. **同花顺** (ths) - 备用 ⭐⭐⭐

#### 期货相关 (60个接口)

**行情数据**:
1. **新浪财经** (sina) - 覆盖全面 ⭐⭐⭐⭐⭐
2. **东方财富** (eastmoney) - 数据完整 ⭐⭐⭐⭐

**官方交易所**:
1. **上期所** (shfe) - 权威 ⭐⭐⭐⭐⭐
2. **大商所** (dce) - 权威 ⭐⭐⭐⭐⭐
3. **郑商所** (czce) - 权威 ⭐⭐⭐⭐⭐
4. **中金所** (cffex) - 权威 ⭐⭐⭐⭐⭐

#### 基金相关 (98个接口)

1. **东方财富** (eastmoney) - 最全 ⭐⭐⭐⭐⭐
2. **新浪财经** (sina) - 备用 ⭐⭐⭐
3. **天天基金** (ttjj) - 专业 ⭐⭐⭐

### 1.4 参数映射规范

akshare 采用统一的参数映射规范：

```python
# 时间周期映射
period_dict = {
    "daily": "101",      # 日线
    "weekly": "102",     # 周线
    "monthly": "103",    # 月线
    "minute": "1",       # 分钟 (东方财富)
    "5min": "5",
    "15min": "15",
    "30min": "30",
    "60min": "60",
}

# 复权方式映射
adjust_dict = {
    "": "0",             # 不复权
    "qfq": "1",          # 前复权
    "hfq": "2",          # 后复权
}

# 市场代码映射
market_code = {
    "6xxxxx": 1,         # 沪深京 (上交所)
    "0xxxxx": 0,         # 深交所
}
```

## 2. akshare-one 可复用的源实现方案

### 2.1 现有源代码复用

akshare-one 可以**直接依赖 akshare** 的以下接口：

#### 可直接包装的接口

```python
# 在 akshare-one 中可直接使用 akshare 的函数
import akshare as ak

# 历史行情 (3+源)
ak.stock_zh_a_hist()          # 东方财富
ak.stock_zh_a_hist_sina()     # 新浪财经 (如果单独实现)

# 实时行情
ak.stock_zh_a_spot_em()       # 东方财富
ak.stock_zh_a_spot_sina()     # 新浪财经

# 财务数据
ak.stock_balance_sheet_by_report_em()
ak.stock_profit_sheet_by_report_em()
ak.stock_cash_flow_sheet_by_report_em()

# 期货
ak.futures_zh_daily_sina()    # 新浪财经
```

### 2.2 适配层设计

为实现 akshare-one 的统一接口，需要适配层：

```python
# akshare_adapter.py
class AkshareHistoricalAdapter(HistoricalDataProvider):
    """将 akshare 的 stock_zh_a_hist 适配为 akshare-one 接口"""
    
    def __init__(self, symbol, interval, **kwargs):
        self.symbol = symbol
        self.interval = self._map_interval(interval)
        self.adjust = kwargs.get('adjust', '')
    
    def _map_interval(self, interval):
        """将 akshare-one 的 interval 映射到 akshare 的 period"""
        mapping = {
            'minute': 'minute',
            'hour': 'hour',
            'day': 'daily',
            'week': 'weekly',
            'month': 'monthly',
        }
        return mapping[interval]
    
    def get_hist_data(self):
        import akshare as ak
        return ak.stock_zh_a_hist(
            symbol=self.symbol,
            period=self.interval,
            adjust=self.adjust,
        )
```

## 3. 推荐的新数据源集成

### 3.1 高优先级新源 (可立即集成)

#### 1. 腾讯财经数据源 (tencent)

**适用场景**:
- 实时行情数据 (响应快)
- 分笔交易数据
- 逐笔明细

**示例实现**:
```python
# realtime/tencent.py
class TencentRealtime(RealtimeDataProvider):
    def __init__(self, symbol):
        self.symbol = self._convert_symbol(symbol)
        # 腾讯财经代码: sh600000 → 0000001
    
    def get_current_data(self):
        # API: http://qt.gtimg.cn/q=
        pass
```

#### 2. 新浪财经数据源 (sina)

**适用场景**:
- 历史行情数据备用
- 基础信息补充
- 新闻数据

**示例实现**:
```python
# info/sina.py
class SinaInfo(InfoDataProvider):
    def get_basic_info(self):
        # 新浪财经个股信息页
        pass
```

### 3.2 中等优先级新源 (近期集成)

#### 1. 同花顺数据源 (ths)

**适用场景**:
- 龙虎榜数据
- 板块数据
- 热点数据

#### 2. 巨潮资讯数据源 (cninfo)

**适用场景**:
- 财务数据 (权威性强)
- 公告数据
- 定期报告

### 3.3 低优先级新源 (后期规划)

#### 1. 官方交易所数据源

- 上交所 (SSE)
- 深交所 (SZSE)
- 中金所 (CFFEX)
- 郑商所 (CZCE)
- 大商所 (DCE)
- 上期所 (SHFE)

## 4. 实现建议总结

| 源 | 模块 | 优先级 | 难度 | 预期收益 |
|----|------|--------|------|----------|
| eastmoney | 所有 | ★★★★★ | 低 | 现有 |
| sina | historical/realtime/info/news | ★★★★ | 低 | 高 |
| tencent | realtime/historical(minute) | ★★★★ | 中 | 中 |
| ths | news/hot | ★★★ | 中 | 中 |
| cninfo | financial | ★★★ | 高 | 高 |
| xueqiu | insider | ★★ | 低 | 低 |

## 5. 关键技术建议

### 5.1 符号转换

不同数据源使用不同的股票代码格式：

```python
# 统一转换规范
def normalize_symbol(symbol, source):
    """
    将 akshare-one 的规范代码转换为各源所需格式
    
    akshare-one: '600000' (仅数字)
    ├─ eastmoney: 'sh600000' 或市场代码+代码
    ├─ sina: 'sh600000' 或 'sh600000'
    ├─ tencent: '0000001' (深交所) 或 '0000001' (上交所)
    └─ xueqiu: 'SH600000' (全大写)
    """
    pass
```

### 5.2 数据格式统一

确保不同源返回相同的 DataFrame 结构：

```python
# 标准化的历史行情格式
HIST_DATA_COLUMNS = [
    'timestamp',   # 时间戳或日期
    'open',        # 开盘价
    'high',        # 最高价
    'low',         # 最低价
    'close',       # 收盘价
    'volume',      # 成交量
    'amount',      # 成交额 (可选)
]

# 标准化的实时行情格式
REALTIME_COLUMNS = [
    'symbol',      # 股票代码
    'price',       # 最新价
    'change',      # 涨跌额
    'pct_change',  # 涨跌幅
    'timestamp',   # 时间戳
    'volume',      # 成交量
    'amount',      # 成交额
]
```

### 5.3 错误处理

不同源的错误场景：

```python
# 东方财富: 服务器限流、超时
# 新浪财经: IP限制、数据缺失
# 腾讯财经: 实时行情延迟、股票代码映射错误

class SourceError(Exception):
    """数据源特定错误"""
    def __init__(self, source, error_type, message):
        self.source = source
        self.error_type = error_type  # rate_limit/timeout/invalid_code/not_found
        self.message = message
```

---

**下一步**: 基于本报告，实施多数据源集成方案。

生成时间: 2026-02-12
